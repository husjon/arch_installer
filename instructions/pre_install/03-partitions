# vim: ft=sh

# pre partition cleanup
umount -R /mnt
rm -rf /mnt/*


# script from: https://superuser.com/a/984637
TOTAL_MEMORY=$(awk '/MemTotal/ {printf "%3.0f", ($2/1024000)}' /proc/meminfo)
SWAP_SIZE=${SWAP_SIZE:-$TOTAL_MEMORY}

(
    echo g                          # clear the in memory partition table

    echo n                          # new partition
    echo 1                          # partition number 1
    echo                            # default - start at beginning of disk
    echo +512M                      # 512 MB boot parttion (EFI)
    echo y                          # in case the signature already exists, this will remove the previous signature

    echo n                          # new partition
    echo 2                          # partion number 2
    echo                            # default, start immediately after preceding partition
    echo +${ROOT_PARTITION_SIZE}G   # 64GB root
    echo y                          # in case the signature already exists, this will remove the previous signature

    echo n                          # new partition
    echo 3                          # partion number 3
    echo                            # default, start immediately after preceding partition
    echo +${SWAP_SIZE}G             # 8GB swap
    echo y                          # in case the signature already exists, this will remove the previous signature

    echo n                          # new partition
    echo 4                          # partion number 4
    echo                            # default, start immediately after preceding partition
    echo                            # default, extend partition to end of disk
    echo y                          # in case the signature already exists, this will remove the previous signature

    echo t                          # partition type
    echo 1                          # partition 1
    echo 1                          # EFI

    echo t                          # partition type
    echo 2                          # partition 2
    echo 24                         # ROOT

    echo t                          # partition type
    echo 3                          # partition 3
    echo 19                         # SWAP

    echo t                          # partition type
    echo 4                          # partition 4
    echo 28                         # HOME

    echo p                          # print the in-memory partition table

    echo w                          # write the partition table
) | fdisk ${TGTDEV}

if [[ ${TGTDEV: -1} =~ [0-9] ]]; then
    # Sets up the partition device naming (ex. with nvme drives named: /dev/nvme0n1)
    TGTDEV=${TGTDEV}p
fi

# create filesystem and swap
mkfs.fat  -F32  ${TGTDEV}1
mkfs.ext4 -F    ${TGTDEV}2
mkswap          ${TGTDEV}3
swapon          ${TGTDEV}3
mkfs.ext4 -F    ${TGTDEV}4


# mount all the partitions
mount           ${TGTDEV}2     /mnt

mkdir -p /mnt/boot/efi
mount           ${TGTDEV}1     /mnt/boot/efi

mkdir -p /mnt/home
mount           ${TGTDEV}4     /mnt/home
